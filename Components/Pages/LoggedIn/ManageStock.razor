@page "/manage_stock"
@inject ISnackbar Snackbar
@inject StockManager StockManager
@inject IDialogService DialogService

@using GimpiesBlazor.Managers
@using GimpiesBlazor.Models.Entities

<AuthorizeView>
    <Authorized>
        <PageTitle>Schoenen beheren</PageTitle>

        <MudTable Items="_stockList"
                  Hover="true"
                  Loading="@_loadingStock"
                  LoadingProgressColor="MudBlazor.Color.Primary"
                  CanCancelEdit="true"
                  EditTrigger="TableEditTrigger.EditButton"
                  EditButtonPosition="TableEditButtonPosition.End"
                  RowEditCommit="async (changes) => await ChangesMade(changes)"
                  MultiSelection="true"
                  @bind-SelectedItems="_selectedStock">
            <ToolBarContent>
                <MudButton Size="@Size.Large" StartIcon="@Icons.Material.Filled.Refresh" OnClick="LoadStock"></MudButton>
                <MudButton Size="@Size.Large" Color="MudBlazor.Color.Success" StartIcon="@Icons.Material.Filled.AddBox" OnClick="AddShoe"></MudButton>
                <MudButton Size="@Size.Large" Color="MudBlazor.Color.Error" StartIcon="@Icons.Material.Filled.Delete" OnClick="DeleteShoe"></MudButton>
                <MudText Typo="Typo.h6">Voorraad</MudText>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Merk</MudTh>
                <MudTh>Type</MudTh>
                <MudTh>Maat</MudTh>
                <MudTh>Kleur</MudTh>
                <MudTh>Aantal</MudTh>
                <MudTh>Prijs</MudTh>
            </HeaderContent>
            <RowTemplate Context="stock">
                <MudTd>@stock.Brand.Name</MudTd>
                <MudTd>@stock.ShoeType.Name</MudTd>
                <MudTd>@stock.Size</MudTd>
                <MudTd>@stock.Color.Name</MudTd>
                <MudTd>@stock.Count</MudTd>
                <MudTd>@stock.Price.ToString("C")</MudTd>
            </RowTemplate>
            <RowEditingTemplate Context="stock">
                <MudTd> <MudTextField @bind-Value="stock.Brand.Name" Required /> </MudTd>
                <MudTd> <MudTextField @bind-Value="stock.ShoeType.Name" Required /> </MudTd>
                <MudTd> <MudTextField @bind-Value="stock.Size" Required /> </MudTd>
                <MudTd> <MudTextField @bind-Value="stock.Color.Name" Required /> </MudTd>
                <MudTd> <MudTextField @bind-Value="stock.Count" Required /> </MudTd>
                <MudTd> <MudTextField @bind-Value="stock.Price" Required /> </MudTd>
            </RowEditingTemplate>
            <PagerContent>
                <MudTablePager />
            </PagerContent>
            <EditButtonContent Context="button">
                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" Class="pa-0" OnClick="@button.ButtonAction" Disabled="false" />
            </EditButtonContent>
        </MudTable>

    </Authorized>

    <NotAuthorized>
        <Login />
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<GimpiesBlazor.Models.Entities.Stock> _stockList = new();
    private bool _loadingStock = false;
    private HashSet<GimpiesBlazor.Models.Entities.Stock> _selectedStock = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadStock();
    }

    private async Task LoadStock()
    {
        await LoadAnim();
        _stockList = await StockManager.GetStock();
    }

    private async Task AddShoe()
    {
        var dialog = await DialogService.ShowAsync<DialogAddShoe>("Nieuwe Schoen Toevoegen");
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            var newShoe = result.Data as GimpiesBlazor.Models.Entities.Stock;

            if (newShoe != null)
            {
                await StockManager.AddStock(newShoe);
                Snackbar.Add("Schoen toegevoegd", Severity.Success);

                await LoadStock();
            }
        }
    }
    private async Task LoadAnim(){
        _loadingStock = true;
        await Task.Delay(500);
        _loadingStock = false;
    }

    private async Task ChangesMade(object element)
    {
        if (element is GimpiesBlazor.Models.Entities.Stock updatedStock)
        {
            await StockManager.UpdateStock(updatedStock);
            Snackbar.Add("Wijzigingen zijn opgeslagen!", Severity.Success);
        }
    }
}
